<!DOCTYPE html>
<html>
<head>
    <title>Climate Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js" crossorigin=""></script>    
    <script src="https://dsps.lib.uiowa.edu/placing/public/leafletSlider-1.0.2/leaflet.SliderControl.min.js"></script>
    <script src="https://dsps.lib.uiowa.edu/placing/public/fuse-1.2.1/fuse.min.js"></script>
    <script src="https://dsps.lib.uiowa.edu/placing/public/leafletFuseSearch-noVersion/leafletfuse.js"></script>
    <link rel="stylesheet" href="https://dsps.lib.uiowa.edu/placing/public/leafletFuseSearch-noVersion/leafletfuse.css" type="text/css"/>
    <script src="https://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css" type="text/css">
    <script src="https://dsps.lib.uiowa.edu/placing/public/jqueryUiTouchPunch-0.2.2/jquery.ui.touch-punch.min.js"></script>
    <script src="https://claireknox.github.io/Final Project/test_data.js"></script>
    <script src="https://claireknox.github.io/Final Project/centroids.js"></script>
    <script src="https://claireknox.github.io/Final Project/disasters.js"></script>
    <link rel="stylesheet" type="text/css" href="https://dsps.lib.uiowa.edu/placing/css/style.css">
    <link rel="stylesheet" type="text/css" href="https://dsps.lib.uiowa.edu/placing/css/navwrap.css">
    
    <style>
        #slider-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 60px auto;
        }
        #slider-labels {
            display: flex;
            position: absolute;
            width: 100px; 
            justify-content: space-between; 
            top: 40px;
            margin: 50px auto;
        }
        .slider-label {
            position: absolute;
            transform: translateX(-65%); 
            text-align: center;
            white-space: nowrap; 
        }
    </style> 
</head>
<body>
    <div id="map" style="width: 100%; height: 750px"></div>
    <div id="slider-container">
        <input id="year-slider" type="range" max="2020" min="1990" step="5" value="1990">
        <div id="slider-labels">
            <span class="slider-label" style="left: 0%;">1990</span>
            <span class="slider-label" style="left: 16.66%;">1995</span>
            <span class="slider-label" style="left: 33.33%;">2000</span>
            <span class="slider-label" style="left: 50%;">2005</span>
            <span class="slider-label" style="left: 66.66%;">2010</span>
            <span class="slider-label" style="left: 83.33%;">2015</span>
            <span class="slider-label" style="left: 100%;">2020</span>
        </div>
    </div>
    <script>
    function getColorFor(value, type) {
            if (type === "temp") {
                return value > 10 ? '#5e0404' :
                    value > 9 ? '#A84040' :
                    value > 8 ? '#B85050' :
                    value > 7 ? '#C96060' :
                    value > 6 ? '#D97B7B' :
                    value > 5 ? '#D98B9F' :
                    value > 4 ? '#D9A39F' :
                    value > 3 ? '#D9B69F' :
                    value > 2 ? '#D9C99F' :
                    value >= 1 ? '#A3D9A5' :
                    value >= (-2) ? '#8FB99F' :
                    value == "null" ? '#f0f0f0' :
                    '#f0f0f0';
            } else if (type === "dis") {
                return value > 75 ? '#211918' :
                    value > 50 ? '#2e0500' :
                    value > 45 ? '#4f2722' :
                    value > 40 ? '#6e3731' :
                    value > 35 ? '#94362c' :
                    value > 30 ? '#8a3801' :
                    value > 25 ? '#ba4c02' :
                    value > 20 ? '#e35c02' :
                    value > 15 ? '#f77620' :
                    value > 10 ? '#f79554' :
                    value >= 5 ? '#fac19b' :
                    value >= 0 ? '#fcd5bb' :
                    '#f0f0f0';
            }
        }
        
        // Function to update the style of the layer based on type of data and year
        function updateStyle(layer, type) {
            var value = layer.feature.properties[currentYear]; 
            layer.setStyle({
                fillColor: getColorFor(value, type),
                color: "#000",
                weight: 1,
                opacity: 1,
                fillOpacity: 0.7
            });
        }

        function updateLayerStyles(layerGroup, type) {
            layerGroup.eachLayer(function (layer) {
                updateStyle(layer, type);
                layer.setPopupContent("Country: " + layer.feature.properties.name + 
                "<br>" + (type === "temp" ? "5 Year Temperature Change: " : "5 Year Disaster Count: ") + 
                layer.feature.properties[currentYear] + (type === "temp" ? " °C" : "") + "<br>Year: " + currentYear);
            });
        }

        var map = L.map("map", {
            layers: [L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ',
                maxZoom: 10
            })],
            center: new L.LatLng(24.5, 15), 
            zoom: 3
        });
        
        var currentYear = 1990; // Default year


        var minValue = 1000000; 
        var minRadius = 10;

        function getRadius(val) {
            return Math.pow(val / minValue, 0.7) * minRadius;
            }

        var temperatureLayer = L.geoJson(temperatureJSON, {
        onEachFeature: function (feature, layer) {
            updateStyle(layer, "temp");
            layer.bindPopup("Country: " + feature.properties.name 
            + "<br>5 Year Temperature Change: " + feature.properties[currentYear] + " °C"
            + "<br>Year: " + currentYear);
        }
    });
        
        var disasterLayer = L.geoJson(disasterJSON, {
            onEachFeature: function (feature, layer) {
                updateStyle(layer, "dis");
                layer.bindPopup("Country: " + feature.properties.name 
                + "<br>5 Year Disaster Count: " + feature.properties[currentYear]
                + "<br>Year: " + currentYear);
            }
        });

        var migrantsLayer = L.geoJson(Centroids, {
            pointToLayer: function(feature, latlng) {
                return L.circleMarker(latlng, {
                    radius: getRadius(feature.properties['migrants_' + currentYear]),
                    fillColor: "#716680",
                    color: "#000",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                });
            },
            onEachFeature: function(feature, layer) {
                layer.bindPopup("Country: " + feature.properties.name 
                + "<br> Total Emigrants: " + feature.properties['migrants_' + currentYear]
                + "<br>Year: " + currentYear);
            }
        }).addTo(map);


        var highlightLayer = L.geoJson(null, {
            style: function (feature) {
                return {
                    color: '#FFFF00',
                    weight: 3,
                    fillOpacity: 0
                };
            }
        }).addTo(map);

        // Source: https://fionnachan.medium.com/how-to-write-a-slider-in-pure-javascript-838c0d98fd69 
        var sliderControl = L.control({ position: 'topright' });
        sliderControl.onAdd = function (map) {
            var sliderContainer = L.DomUtil.create('div', 'slider-container');
            var slider = L.DomUtil.create('input', 'range-slider', sliderContainer);
            slider.style.width = '270px';
            const years = [1990, 1995, 2000, 2005, 2010, 2015, 2020];
            years.forEach((year, index) => {
                var label = L.DomUtil.create('span', 'slider-label', sliderContainer);
                label.style.left = `${(index / (years.length - 1)) * 100}%`;
                label.innerText = year;
            });

            L.DomEvent.addListener(slider, 'mousedown', function (e) {
                L.DomEvent.stopPropagation(e);
            });
            $(slider).attr({'type': 'range', 'max': 2020, 'min': 1990, 'step': 5, 'value': String(currentYear)})
                .on('input change', function () {
                    currentYear = this.value;
                    updateLayerStyles(temperatureLayer, "temp");
                    updateLayerStyles(disasterLayer, "dis");
                    migrantsLayer.eachLayer(function (layer) {
                        var newRadius = getRadius(layer.feature.properties['migrants_' + currentYear]);
                        layer.setRadius(newRadius);
                        layer.setPopupContent("Country: " + layer.feature.properties.name 
                        + "<br>Total Emigrants: " + layer.feature.properties['migrants_' + currentYear]
                        + "<br>Year: " + currentYear);
                    });
                    migrantsLayer.bringToFront(); // Bring migrants layer to the front
                });

                return sliderContainer;
            };
        sliderControl.addTo(map);


        // Search section
        var searchOptions = {
                position: 'topleft',
                title: 'Search',
                placeholder: 'Example: United States',
                maxResultLength: 10,
                caseSensitive: false,
                showInvisibleFeatures: true,
                threshold: 0.5, // default is .5, will match imperfect results
                showResultFct: function(feature, container) {
                    var props = feature.properties;
                    var name = L.DomUtil.create('b', null, container);
                    name.innerHTML = props.name;
                    container.appendChild(L.DomUtil.create('br', null, container));
                }
            };

            var searchControl = L.control.fuseSearch(searchOptions);
                map.addControl(searchControl);
                searchControl.indexFeatures(Centroids, ['name']);

                    searchControl.on('results', function(data) {
                        highlightLayer.clearLayers();
                        for (var i = data.results.length - 1; i >= 0; i--) {
                            highlightLayer.addData(data.results[i].feature);
                        }
                    });

        var overlays = {
            "5 Year Temperature Change": temperatureLayer,
            "5 Year Disaster Count": disasterLayer
        };

        var baseMaps = {
            "Total Emigrants": migrantsLayer
        };

        L.control.layers(overlays, baseMaps, {collapsed:false}).addTo(map);

        map.on('overlayadd', function(eventLayer) {
            if (eventLayer.name === 'Total Emigrants') {
                migrantsLayer.bringToFront();
            }
        });
             map.on('overlayremove', function(eventLayer) {
            if (eventLayer.name === '5 Year Temperature Change' || eventLayer.name === '5 Year Disaster Count') {
                migrantsLayer.bringToFront();
            }
        });

    </script>
</body>
</html>
